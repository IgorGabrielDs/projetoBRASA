{% extends "base.html" %}
{% load static %}

{% block title %}{{ noticia.titulo }} â€” JC{% endblock %}

{% block content %}
<article class="article-detail container">

  {% with assunto=noticia.assuntos.first %}
    {% if assunto %}
      <div class="topic">{{ assunto.nome }}</div>
    {% endif %}
  {% endwith %}

  <h1 class="headline">{{ noticia.titulo }}</h1>

  <div class="meta">
    {% if noticia.criado_em %}Publicado em {{ noticia.criado_em|date:"d/m/Y H:i" }}{% endif %}
    {% if noticia.autor %} â€¢ {{ noticia.autor }}{% endif %}
  </div>

  {% if noticia.imagem %}
  <figure class="cover figure">
    <img src="{{ noticia.imagem.url }}" alt="{{ noticia.titulo }}">
    {% if noticia.legenda or noticia.credito %}
      <figcaption>
        {{ noticia.legenda }}{% if noticia.credito %} â€” {{ noticia.credito }}{% endif %}
      </figcaption>
    {% endif %}
  </figure>
  {% endif %}

  <div class="content">
    {{ noticia.conteudo|linebreaks }}
  </div>

  <!-- Barra de aÃ§Ãµes -->
  <div class="article-actions" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">

    {# BotÃ£o "Ver mais tarde" controlado por JS (sem recarregar) #}
    <button
      type="button"
      class="btn btn-outline btn-save bookmark{% if is_saved %} is-saved{% endif %}"
      data-salvo-url="{% url 'noticias:toggle_salvo' noticia.pk %}"
      aria-label="{% if is_saved %}Retirar de Ver mais tarde{% else %}Ver mais tarde{% endif %}">
      ðŸ”– {% if is_saved %}Retirar de Ver mais tarde{% else %}Ver mais tarde{% endif %}
    </button>

    <!-- Fallback sem JS -->
    <noscript>
      <form method="post" action="{% url 'noticias:toggle_salvo' noticia.pk %}">
        {% csrf_token %}
        <button class="btn btn-outline btn-save" type="submit">
          {% if is_saved %}Retirar de Ver mais tarde{% else %}Ver mais tarde{% endif %}
        </button>
      </form>
    </noscript>

    <!-- Compartilhar -->
    <button class="btn btn-outline btn-share" type="button" id="btn-share">
      Compartilhar
    </button>
  </div>

  <!-- VotaÃ§Ã£o -->
  <!-- VotaÃ§Ã£o -->
<section class="vote" style="margin-top:14px">
  <div class="vote-box" data-votos-box
       style="display:flex;gap:16px;align-items:center;flex-wrap:wrap;background:#f7f7f8;border:1px solid #e5e7eb;border-radius:12px;padding:8px 12px">

    <div class="vote-row" style="display:flex;gap:6px;align-items:center">
      {# BotÃ£o de voto positivo (JS) #}
      <button
        type="button"
        class="btn-vote btn-voto{% if voto_usuario == 1 %} is-active{% endif %}"
        data-votar-url="{% url 'noticias:votar' noticia.pk %}"
        data-valor="1" aria-label="Gostei" title="Gostei">â†‘</button>
      <span class="score" data-upcount aria-live="polite">{{ up }}</span>

      <noscript>
        <form method="post" action="{% url 'noticias:votar' noticia.pk %}">
          {% csrf_token %}
          <input type="hidden" name="valor" value="1">
          <button class="btn-vote" aria-label="Gostei" title="Gostei">â†‘</button>
        </form>
      </noscript>
    </div>

    <div class="vote-row" style="display:flex;gap:6px;align-items:center">
      {# BotÃ£o de voto negativo (JS) #}
      <button
        type="button"
        class="btn-vote btn-voto{% if voto_usuario == -1 %} is-active{% endif %}"
        data-votar-url="{% url 'noticias:votar' noticia.pk %}"
        data-valor="-1" aria-label="NÃ£o gostei" title="NÃ£o gostei">â†“</button>
      <span class="score" data-downcount aria-live="polite">{{ down }}</span>

      <noscript>
        <form method="post" action="{% url 'noticias:votar' noticia.pk %}">
          {% csrf_token %}
          <input type="hidden" name="valor" value="-1">
          <button class="btn-vote" aria-label="NÃ£o gostei" title="NÃ£o gostei">â†“</button>
        </form>
      </noscript>
    </div>

  </div>
</section>

  <!-- Resumo por IA -->
  <section class="ai-panel" style="margin-top:18px">
    <div class="ai-title">Resumir notÃ­cia</div>
    <button class="btn btn-ai" type="button" id="btn-resumir">Resumir notÃ­cia</button>

    <div class="ai-summary" id="ai-summary" style="display:none">
      <div class="summary-title">Resumo gerado</div>
      <div id="ai-text"></div>
      <div class="summary-actions" style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn-outline btn-copy" type="button" id="btn-copy">Copiar</button>
        <button class="btn btn-outline btn-close" type="button" id="btn-close">Fechar</button>
      </div>
    </div>
  </section>

  <!-- Leia tambÃ©m -->
  {% if top3 %}
  <div class="readmore">
    <span class="label">Leia tambÃ©m</span>
    {% for n in top3 %}
      <a class="link" href="{{ n.get_absolute_url }}">{{ n.titulo }}</a>
    {% endfor %}
  </div>
  {% endif %}

</article>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    // Compartilhar (Web Share API com fallback)
    document.getElementById('btn-share')?.addEventListener('click', async () => {
      const data = { title: document.title, text: '{{ noticia.titulo|escapejs }}', url: window.location.href };
      if (navigator.share) { try { await navigator.share(data); } catch(e) {} }
      else { try { await navigator.clipboard.writeText(data.url); } catch(e) {} alert('Link copiado!'); }
    });

    // Util: pegar CSRF do cookie (ou meta) â€” se vocÃª jÃ¡ tem no jc.js, pode remover daqui
    function getCookie(name) {
      const m = document.cookie.match(new RegExp('(^|; )' + name + '=([^;]*)'));
      return m ? decodeURIComponent(m[2]) : null;
    }

    // Resumo por IA (AJAX)
    const btnResumir = document.getElementById('btn-resumir');
    const box = document.getElementById('ai-summary');
    const txt = document.getElementById('ai-text');
    const btnCopy = document.getElementById('btn-copy');
    const btnClose = document.getElementById('btn-close');

    btnResumir?.addEventListener('click', async () => {
      btnResumir.disabled = true; btnResumir.textContent = 'Gerando...';
      try {
        const resp = await fetch("{% url 'noticias:resumir_noticia' noticia.pk %}", {
          method: 'POST',
          headers: {
            'X-Requested-With':'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken') || ''
          }
        });
        const data = await resp.json();
        if (data.resumo) { txt.textContent = data.resumo; box.style.display = 'block'; }
        else { alert(data.error || 'NÃ£o foi possÃ­vel gerar o resumo.'); }
      } catch(e){ alert('Falha de rede.'); }
      finally { btnResumir.disabled = false; btnResumir.textContent = 'Resumir notÃ­cia'; }
    });

    btnCopy?.addEventListener('click', async () => {
      if (!txt.textContent) return;
      try { await navigator.clipboard.writeText(txt.textContent); } catch(e) {}
      alert('Resumo copiado!');
    });
    btnClose?.addEventListener('click', () => { box.style.display = 'none'; });
  </script>
{% endblock %}
